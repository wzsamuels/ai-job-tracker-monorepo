name: Build & Deploy Backend with PM2

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Cache NPM Dependencies
      uses: actions/cache@v3
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('apps/backend/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install & Build Backend
      run: |
        cd apps/backend
        npm ci
        npm run build

    - name: Upload dist/ via SCP
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: "apps/backend/dist/*"
        target: "/home/ubuntu/ai-job-tracker/apps/backend/dist"

    - name: Restart PM2 via ecosystem.config.js
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/ubuntu/ai-job-tracker
          pm2 start ecosystem.config.js --only ai-job-tracker-backend
          pm2 reload ecosystem.config.js --only ai-job-tracker-backend
