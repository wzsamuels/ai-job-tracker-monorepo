name: Build & Deploy Backend (pnpm + Turbo + PM2)

on:
  push:
    branches: [main]
    paths:
      - 'apps/backend/**'
      - 'packages/db/**'
      - 'packages/validators/**'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v3

    - name: Enable corepack and setup pnpm
      run: |
        corepack enable
        corepack prepare pnpm@8.15.1 --activate

    - name: Cache pnpm store
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-

    - name: Install Dependencies
      run: pnpm install

    - name: Cache Turbo Cache
      uses: actions/cache@v3
      with:
        path: .turbo
        key: ${{ runner.os }}-turbo-${{ hashFiles('**/*.[tj]s', '**/tsconfig.json') }}
        restore-keys: |
          ${{ runner.os }}-turbo-

    - name: Type Check
      run: pnpm turbo run typecheck --filter=backend

    - name: Build Backend with Dependencies
      run: NODE_ENV=production pnpm turbo run build --filter=backend...

    - name: Check dist exists
      run: |
        if [ ! -d apps/backend/dist ]; then
          echo "‚ùå Build output not found in apps/backend/dist"
          exit 1
        fi

    - name: Upload dist/ via SCP
      uses: appleboy/scp-action@v0.1.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        source: "apps/backend/dist/*"
        target: "/home/ubuntu/ai-job-tracker/apps/backend/dist"

    - name: Restart PM2 via ecosystem.config.js
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /home/ubuntu/ai-job-tracker
          pm2 start ecosystem.config.js --only ai-job-tracker-backend --env production
          pm2 reload ecosystem.config.js --only ai-job-tracker-backend
